<div class="resenas-container">
  <!-- Header din√°mico -->
  <div class="resenas-header">
    <div class="header-content">
      <button *ngIf="mostrarBotonVolver" (click)="volverALugares()" class="btn-volver">
        <span>‚Üê</span>
        Volver a lugares
      </button>
      <h1 class="resenas-title">{{ tituloPagina }}</h1>
      <p class="resenas-subtitle">{{ subtituloPagina }}</p>
    </div>
  </div>

  <!-- Bot√≥n flotante para agregar rese√±a -->
  <button
    *ngIf="!mostrarFormulario"
    (click)="mostrarFormulario = true"
    class="btn-flotante"
    aria-label="Agregar nueva rese√±a">
    <span class="btn-flotante-icon">+</span>
    <span class="btn-flotante-text">Agregar Rese√±a</span>
  </button>

  <!-- Modal para formulario -->
  <div *ngIf="mostrarFormulario" class="modal-overlay" (click)="cerrarModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>
          {{ lugarId ? 'Agregar Rese√±a a ' + lugarNombre : 'Agregar Nueva Rese√±a' }}
        </h2>
        <button
          (click)="cerrarModal()"
          class="btn-cerrar-modal"
          type="button"
          aria-label="Cerrar formulario">
          <span>√ó</span>
        </button>
      </div>

      <form (ngSubmit)="probarAgregarResena()" class="resena-form">
        <!-- T√≠tulo -->
        <div class="form-group">
          <label for="titulo" class="form-label">T√≠tulo de la Rese√±a</label>
          <input
            type="text"
            id="titulo"
            name="titulo"
            [(ngModel)]="nuevaResena.titulo"
            required
            class="form-input"
            placeholder="Ej: Excelente experiencia en la playa"
            maxlength="60">
          <div class="char-counter">{{ nuevaResena.titulo.length }}/60</div>
        </div>

        <!-- Calificaci√≥n con estrellas interactivas -->
        <div class="form-group">
          <label class="form-label">Calificaci√≥n</label>
          <div class="estrellas-interactivas">
            <button
              type="button"
              *ngFor="let star of [1,2,3,4,5]; let i = index"
              (click)="nuevaResena.calificacion = i + 1"
              (mouseenter)="estrellasHover = i + 1"
              (mouseleave)="estrellasHover = 0"
              class="estrella-btn"
              [class.active]="(estrellasHover || nuevaResena.calificacion) > i"
              [class.selected]="nuevaResena.calificacion > i">
              ‚òÖ
            </button>
          </div>
          <div class="calificacion-texto">
            {{ getTextoCalificacion(nuevaResena.calificacion) }} ({{ nuevaResena.calificacion }}/5)
          </div>
        </div>

        <!-- Contenido -->
        <div class="form-group">
          <label for="contenido" class="form-label">Tu Experiencia</label>
          <textarea
            id="contenido"
            name="contenido"
            [(ngModel)]="nuevaResena.contenido"
            required
            rows="5"
            class="form-textarea"
            placeholder="Describe tu experiencia en este lugar... ¬øQu√© te gust√≥? ¬øQu√© mejorar√≠as?"
            maxlength="500">
          </textarea>
          <div class="char-counter">{{ nuevaResena.contenido.length }}/500</div>
        </div>

        <!-- Botones del formulario -->
        <div class="form-actions">
          <button
            type="button"
            (click)="cerrarModal()"
            class="btn btn-secondary"
            [disabled]="cargando">
            Cancelar
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="cargando || !esFormularioValido()">
            <span *ngIf="cargando" class="loading-spinner"></span>
            {{ cargando ? 'Publicando...' : 'Publicar Rese√±a' }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Estad√≠sticas -->
  <div *ngIf="resenas.length > 0" class="estadisticas-container">
    <div class="estadistica">
      <div class="estadistica-valor">{{ resenas.length }}</div>
      <div class="estadistica-label">Rese√±as</div>
    </div>
    <div class="estadistica">
      <div class="estadistica-valor">{{ promedioCalificacion | number:'1.1-1' }}</div>
      <div class="estadistica-label">Calificaci√≥n Promedio</div>
    </div>
    <div class="estadistica">
      <div class="estadistica-valor">{{ distribucionCalificaciones[5] || 0 }}</div>
      <div class="estadistica-label">Excelente</div>
    </div>
  </div>

  <!-- Lista de rese√±as -->
  <div class="lista-resenas">
    <div class="lista-header">
      <h2>Rese√±as de la Comunidad</h2>
      <div class="filtros">
        <select [(ngModel)]="filtroCalificacion" (change)="aplicarFiltros()" class="filtro-select">
          <option value="0">Todas las calificaciones</option>
          <option value="5">‚òÖ 5 estrellas</option>
          <option value="4">‚òÖ 4 estrellas</option>
          <option value="3">‚òÖ 3 estrellas</option>
          <option value="2">‚òÖ 2 estrellas</option>
          <option value="1">‚òÖ 1 estrella</option>
        </select>

        <select [(ngModel)]="ordenamiento" (change)="aplicarFiltros()" class="filtro-select">
          <option value="fecha_desc">M√°s recientes primero</option>
          <option value="fecha_asc">M√°s antiguas primero</option>
          <option value="calificacion_desc">Mejor calificadas</option>
          <option value="calificacion_asc">Peor calificadas</option>
        </select>
      </div>
    </div>

    <!-- Estado de carga -->
    <div *ngIf="cargandoResenas" class="estado-carga">
      <div class="loading-spinner large"></div>
      <p>Cargando rese√±as...</p>
    </div>

    <!-- Sin rese√±as - MEJORADO -->
    <div *ngIf="!cargandoResenas && resenasFiltradas.length === 0" class="sin-resenas">
      <div class="sin-resenas-icon">üí¨</div>

      <h3 *ngIf="lugarId">No hay rese√±as para {{ lugarNombre }}</h3>
      <h3 *ngIf="!lugarId">No hay rese√±as a√∫n</h3>

      <p *ngIf="lugarId">
        ¬°S√© el primero en compartir tu experiencia sobre {{ lugarNombre }}!
      </p>
      <p *ngIf="!lugarId">
        ¬°S√© el primero en compartir tu experiencia con la comunidad!
      </p>

      <button
        (click)="mostrarFormulario = true"
        class="btn btn-primary">
        Agregar Primera Rese√±a
      </button>
    </div>

    <!-- Grid de rese√±as -->
    <div *ngIf="!cargandoResenas && resenasFiltradas.length > 0" class="resenas-grid">
      <div
        *ngFor="let resena of resenasPaginadas"
        class="resena-card"
        [class.resena-destacada]="resena.puntuacion === 5">
        <div class="resena-header">
          <div class="resena-info">
            <h3 class="resena-titulo">{{ obtenerTitulo(resena) }}</h3>
            <div class="resena-meta">
              <div class="calificacion-resena">
                <span class="estrellas" [title]="resena.puntuacion + ' estrellas'">
                  {{ '‚òÖ'.repeat(resena.puntuacion) }}{{ '‚òÜ'.repeat(5 - resena.puntuacion) }}
                </span>
                <span class="puntuacion-numero">{{ resena.puntuacion }}</span>
              </div>
              <span class="fecha-resena">{{ resena.fecha | date:'dd/MM/yyyy' }}</span>
            </div>
          </div>
          <button
            (click)="confirmarEliminacion(resena)"
            class="btn-eliminar-resena"
            title="Eliminar rese√±a">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
            </svg>
          </button>
        </div>

        <p class="contenido-resena">{{ obtenerContenido(resena) }}</p>

        <div class="resena-footer">
          <span class="resena-id">#{{ resena.id_resenas }}</span>
          <span class="resena-calificacion-texto">
            {{ getTextoCalificacion(resena.puntuacion) }}
          </span>
        </div>
      </div>
    </div>

    <!-- Paginaci√≥n -->
    <div *ngIf="resenasFiltradas.length > itemsPorPagina" class="paginacion">
      <button
        (click)="paginaAnterior()"
        [disabled]="paginaActual === 1"
        class="btn-paginacion">
        ‚Üê Anterior
      </button>
      <span class="info-paginacion">
        P√°gina {{ paginaActual }} de {{ totalPaginas }}
      </span>
      <button
        (click)="paginaSiguiente()"
        [disabled]="paginaActual === totalPaginas"
        class="btn-paginacion">
        Siguiente ‚Üí
      </button>
    </div>
  </div>

  <!-- Modal de confirmaci√≥n para eliminar -->
  <div *ngIf="mostrarConfirmacionEliminar" class="modal-overlay" (click)="cancelarEliminacion()">
    <div class="modal-content confirmation-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Confirmar Eliminaci√≥n</h2>
      </div>
      <div class="confirmacion-body">
        <p>¬øEst√°s seguro de que quieres eliminar esta rese√±a?</p>
        <p class="resena-preview">"{{ obtenerTitulo(resenaAEliminar!) }}"</p>
      </div>
      <div class="confirmacion-actions">
        <button (click)="cancelarEliminacion()" class="btn btn-secondary">
          Cancelar
        </button>
        <button (click)="eliminarResenaConfirmada()" class="btn btn-danger">
          S√≠, Eliminar
        </button>
      </div>
    </div>
  </div>
</div>